{% extends 'inventory/base.html' %}
{% block content %}

<style>
    /* --- Layout Grid --- */
    .sales-grid {
        display: grid;
        grid-template-columns: 1.5fr 1fr; 
        gap: 1.5rem;
        height: calc(100vh - 100px);
    }

    @media (max-width: 992px) {
        .sales-grid { grid-template-columns: 1fr; height: auto; }
    }

    /* --- Receipt Card --- */
    .receipt-card {
        background-color: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: 100%;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }

    .receipt-header {
        background-color: var(--bg-secondary);
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .receipt-body {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0;
    }

    .receipt-table {
        width: 100%;
        border-collapse: collapse;
    }
    .receipt-table th {
        text-align: left;
        padding: 1rem 1.5rem;
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--text-muted);
        border-bottom: 1px solid var(--border-color);
        background-color: var(--bg-primary);
        position: sticky;
        top: 0;
    }
    .receipt-table td {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-main);
        font-size: 0.95rem;
    }

    .receipt-footer {
        background-color: var(--bg-secondary);
        padding: 1.5rem;
        border-top: 1px solid var(--border-color);
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: var(--text-muted);
    }
    .summary-row.total {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px dashed var(--border-color);
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent-blue);
    }

    .discount-input-sm {
        width: 100px;
        text-align: right;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 2px 8px;
        font-weight: 600;
        color: var(--text-main);
    }

    /* --- Input Panel --- */
    .input-card {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 2rem;
        height: fit-content;
    }

    .pos-input {
        background-color: var(--bg-primary) !important;
        border: 1px solid var(--border-color) !important;
        color: var(--text-main) !important;
        padding: 1rem;
        border-radius: 12px;
        font-size: 1rem;
    }

    .btn-add-item {
        background-color: var(--bg-primary);
        border: 1px solid var(--border-color);
        color: var(--text-main);
        padding: 1rem;
        border-radius: 12px;
        font-weight: 600;
        width: 100%;
    }

    .btn-checkout {
        background: linear-gradient(135deg, #0d6efd 0%, #0043a8 100%);
        border: none;
        color: white;
        padding: 1rem;
        border-radius: 12px;
        font-weight: 600;
        width: 100%;
        font-size: 1.1rem;
        box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);
    }
    
    .remove-btn { color: #ef4444; cursor: pointer; padding: 4px; border-radius: 4px; }
</style>

<script>
    // inventoryProducts now includes average_cost from backend
    const inventoryProducts = JSON.parse('{{ products_json|safe }}');
</script>

<div class="sales-grid">
    
    <div class="receipt-card">
        <div class="receipt-header">
            <div>
                <h5 class="fw-bold mb-0">Current Sale</h5>
                <small style="color: var(--text-muted);">Receipt #<span id="receiptNo">--</span></small>
            </div>
            <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill" id="dateDisplay"></span>
        </div>

        <div class="receipt-body custom-scroll">
            <table class="receipt-table">
                <thead>
                    <tr>
                        <th style="width: 40%;">Item</th>
                        <th style="width: 20%;">Price</th>
                        <th style="width: 20%;">Qty</th>
                        <th style="width: 20%; text-align: right;">Total</th>
                        <th style="width: 5%;"></th>
                    </tr>
                </thead>
                <tbody id="cartTableBody">
                    <tr id="emptyCartMsg">
                        <td colspan="5" class="text-center py-5" style="color: var(--text-muted);">
                            <i class="bi bi-cart3 display-4 d-block mb-3 opacity-50"></i>
                            Scan or add items to start.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="receipt-footer">
            <div class="summary-row">
                <span>Subtotal</span>
                <span id="subtotalDisplay">PKR 0</span>
            </div>
            <div class="summary-row">
                <span>Flat Discount</span>
                <input type="number" id="discountInput" class="discount-input-sm" value="0" min="0" oninput="calculateFinalTotal()">
            </div>
            <div class="summary-row">
                <span>Tax (0%)</span>
                <span id="taxDisplay">PKR 0</span>
            </div>
            <div class="summary-row total">
                <span>Total</span>
                <span id="totalDisplay">PKR 0</span>
            </div>
            
            <button class="btn-checkout mt-3" onclick="processCheckout()" id="checkoutBtn" disabled>
                Complete Sale
            </button>
        </div>
    </div>

    <div class="d-flex flex-column gap-4">
        <div class="input-card">
            <h5 class="fw-bold mb-4">Add Item</h5>
            <div class="mb-3">
                <label class="small fw-bold text-uppercase mb-2" style="color: var(--text-muted);">Product</label>
                <input class="form-control pos-input" list="productOptions" id="productInput" placeholder="Type to search..." autocomplete="off">
                <datalist id="productOptions"></datalist>
            </div>
            <div class="mb-4">
                <label class="small fw-bold text-uppercase mb-2" style="color: var(--text-muted);">Quantity</label>
                <input type="number" class="form-control pos-input" id="qtyInput" value="1" min="1">
            </div>
            <button class="btn-add-item" onclick="addToCart()">
                <i class="bi bi-plus-lg me-2"></i> Add to Receipt
            </button>
        </div>
        
        <div id="validationWarning" class="alert alert-danger border-0 shadow-sm rounded-3 d-none">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span id="warningMsg"></span>
        </div>

        <div class="input-card flex-grow-1" style="background-color: transparent; border: none; padding: 0;">
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} border-0 shadow-sm mb-3 rounded-3">
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}
            
            <div class="alert alert-secondary border-0 shadow-sm rounded-3">
                <h6 class="fw-bold"><i class="bi bi-lightbulb-fill me-2 text-warning"></i>Tip</h6>
                <p class="small mb-0 opacity-75">
                    Discounts cannot lower the sale price below the item's purchase cost.
                </p>
            </div>
        </div>
    </div>

</div>

<script>
    const productList = document.getElementById('productOptions');
    const productInput = document.getElementById('productInput');
    const qtyInput = document.getElementById('qtyInput');
    const cartTableBody = document.getElementById('cartTableBody');
    const emptyCartMsg = document.getElementById('emptyCartMsg');
    const discountInput = document.getElementById('discountInput');
    const warningDiv = document.getElementById('validationWarning');
    const warningMsg = document.getElementById('warningMsg');
    
    inventoryProducts.forEach(p => {
        const option = document.createElement('option');
        option.value = p.name;
        productList.appendChild(option);
    });

    document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString();
    document.getElementById('receiptNo').innerText = Math.floor(Math.random() * 100000);

    let cart = [];

    function addToCart() {
        const name = productInput.value;
        const qty = parseInt(qtyInput.value);
        const product = inventoryProducts.find(p => p.name.toLowerCase() === name.toLowerCase());

        if (!product) { alert("Product not found!"); return; }
        if (qty <= 0 || isNaN(qty)) { alert("Invalid quantity."); return; }
        if (product.quantity < qty) { alert(`Only ${product.quantity} available.`); return; }

        const existingItem = cart.find(item => item.id === product.id);
        if (existingItem) {
            existingItem.qty += qty;
        } else {
            cart.push({
                id: product.id,
                name: product.name,
                price: product.selling_price,
                cost: product.average_cost, // Store cost for client-side validation hint
                qty: qty
            });
        }
        renderCart();
        productInput.value = "";
        qtyInput.value = "1";
        productInput.focus();
    }

    function renderCart() {
        cartTableBody.innerHTML = "";
        if (cart.length === 0) {
            cartTableBody.appendChild(emptyCartMsg);
            document.getElementById('checkoutBtn').disabled = true;
            calculateFinalTotal();
            return;
        }
        cart.forEach((item, index) => {
            const lineTotal = item.price * item.qty;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="fw-medium">${item.name}</td>
                <td>${item.price}</td>
                <td>${item.qty}</td>
                <td class="text-end fw-bold">${lineTotal}</td>
                <td class="text-center"><i class="bi bi-x-lg remove-btn" onclick="removeFromCart(${index})"></i></td>
            `;
            cartTableBody.appendChild(row);
        });
        document.getElementById('checkoutBtn').disabled = false;
        calculateFinalTotal();
    }

    function removeFromCart(index) { cart.splice(index, 1); renderCart(); }

    function calculateFinalTotal() {
        let subtotal = 0;
        let totalCost = 0;
        cart.forEach(item => {
            subtotal += (item.price * item.qty);
            totalCost += (item.cost * item.qty);
        });

        let discount = parseInt(discountInput.value) || 0;
        
        // Client-side validation hint
        if (discount > 0 && (subtotal - discount) < totalCost) {
            warningDiv.classList.remove('d-none');
            warningMsg.innerText = `Warning: Sale price (PKR ${subtotal - discount}) is below cost (PKR ${totalCost}).`;
        } else {
            warningDiv.classList.add('d-none');
        }

        document.getElementById('subtotalDisplay').innerText = `PKR ${subtotal}`;
        // Final Total = (Subtotal - Discount) + Tax (Tax is 0%)
        document.getElementById('totalDisplay').innerText = `PKR ${subtotal - discount}`;
    }

    function processCheckout() {
        if (cart.length === 0) return;
        const btn = document.getElementById('checkoutBtn');
        btn.innerText = "Processing...";
        btn.disabled = true;

        fetch("{% url 'sales' %}", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
            body: JSON.stringify({ items: cart, discount: parseInt(discountInput.value) || 0 })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.reload();
            } else {
                alert("Error: " + data.message);
                btn.innerText = "Complete Sale";
                btn.disabled = false;
            }
        });
    }
</script>
{% endblock %}