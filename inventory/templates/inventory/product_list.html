{% extends 'inventory/base.html' %}
{% block content %}

<style>
    /* --- Custom Table Styling --- */
    .custom-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .custom-table th {
        background-color: var(--bg-secondary);
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        border-top: 1px solid var(--border-color);
    }
    
    .custom-table td {
        padding: 1rem;
        background-color: var(--bg-primary);
        border-bottom: 1px solid var(--border-color);
        color: var(--text-main);
        vertical-align: middle;
        transition: background-color 0.2s;
    }
    
    .custom-table tr:hover td {
        background-color: var(--bg-hover);
    }

    /* --- Search Input Fixes --- */
    .search-input {
        background-color: var(--bg-primary) !important;
        border: 1px solid var(--border-color) !important;
        color: var(--text-main) !important; /* Ensures typed text is visible */
        padding: 0.6rem 1rem;
        border-radius: 8px 0 0 8px;
    }
    
    /* Placeholder Visibility Fix */
    .search-input::placeholder {
        color: var(--text-muted) !important;
        opacity: 0.8;
    }

    .search-input:focus {
        border-color: var(--accent-blue) !important;
        box-shadow: none !important;
    }
    .search-btn {
        border-radius: 0 8px 8px 0;
    }

    /* --- Action Buttons (Transparent Outline Style) --- */
    .btn-action-sm {
        background-color: transparent;
        border: 1px solid transparent;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease-in-out;
        box-shadow: none;
        font-weight: 600;
    }
    
    /* Hover Lift & Fill Effect */
    .btn-action-sm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        color: white !important;
    }

    /* Add Product (Emerald) */
    .btn-add {
        color: #10b981;
        border-color: #10b981;
    }
    .btn-add:hover {
        background-color: #10b981;
    }

    /* Category (Indigo) */
    .btn-cat {
        color: #6366f1;
        border-color: #6366f1;
    }
    .btn-cat:hover {
        background-color: #6366f1;
    }

    /* --- Modal Fixes for Dark Mode --- */
    .modal-content {
        background-color: var(--bg-primary);
        color: var(--text-main);
        border: 1px solid var(--border-color);
    }
    .modal-header, .modal-footer {
        border-color: var(--border-color);
    }
    /* Invert close button in dark mode */
    [data-theme="dark"] .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold mb-1" style="color: var(--text-main);">Products</h2>
        <p class="small mb-0" style="color: var(--text-muted);">Manage and track your inventory</p>
    </div>
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-action-sm btn-cat" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
            <i class="bi bi-tags"></i> Category
        </button>
        <button type="button" class="btn btn-action-sm btn-add" data-bs-toggle="modal" data-bs-target="#addProductModal">
            <i class="bi bi-plus-lg"></i> Add Product
        </button>
    </div>
</div>

<div class="card shadow-sm border-0 overflow-hidden">
    <div class="p-3" style="background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
        <form method="get" class="d-flex" style="max-width: 400px;">
            <input type="text" name="q" class="form-control search-input" placeholder="Search by name, company..." value="{{ request.GET.q }}">
            <button class="btn btn-primary search-btn" type="submit"><i class="bi bi-search"></i></button>
        </form>
    </div>

    <div class="table-responsive">
        <table class="custom-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Company</th>
                    <th>Category</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td class="fw-bold">{{ item.name }}</td>
                    <td>{{ item.company }}</td>
                    <td>
                        <span class="badge rounded-pill fw-normal" 
                              style="background-color: var(--bg-secondary); color: var(--text-main); border: 1px solid var(--border-color);">
                            {{ item.category.name }}
                        </span>
                    </td>
                    <td class="font-monospace">PKR {{ item.selling_price }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>
                        {% if item.quantity < 10 %} 
                            <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 px-3">Low Stock</span>
                        {% else %}
                            <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-3">In Stock</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center py-5">
                        <div class="text-muted">
                            <i class="bi bi-box-seam display-4 d-block mb-3 opacity-50"></i>
                            No products found.
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addProductForm" action="{% url 'add_product' %}" method="post">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">Company</label>
                        <input type="text" name="company" class="form-control" value="Unknown">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">Category</label>
                        <select name="category" class="form-select">
                            {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label text-muted small fw-bold">Selling Price</label>
                            <input type="number" name="selling_price" class="form-control" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label text-muted small fw-bold">Avg Cost</label>
                            <input type="number" name="average_cost" class="form-control" value="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">Initial Quantity</label>
                        <input type="number" name="quantity" class="form-control" value="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{% url 'add_category' %}" method="post">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">Category Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.getElementById('addProductForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const form = this;
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                var modalEl = document.getElementById('addProductModal');
                var modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) { modal.hide(); }
                window.location.reload();
            } else {
                alert('Error: ' + JSON.stringify(data.errors));
            }
        })
        .catch(error => console.error('Error:', error));
    });
</script>
{% endblock %}